@page
@model information_system.Areas.Identity.Pages.Account.Manage.LoanModel
@inject UserManager<User> userManager
<style>
    img {
        width: 50px;
        height: 50px;
        object-fit: cover;
    }
</style>
<h3> Заявки на книги</h3>
<table class="table table-striped" id="tablel">
    <thead>
        <tr>
            <th>Дата</th>
            <th>Изображение</th>
            <th>Название книги</th>
            <th>Статус</th>
            <th> </th>
        </tr>
    </thead>
</table>

<script src="~/lib/html2pdf.js/html2pdf.bundle.min.js"></script>
<script src='@Url.Content("~/lib/jquery/dist/jquery.js")' type="text/javascript"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script>
<script>
    var dataTable = [];
        InitPage();
        function InitPage() {
            $.ajax({
                type: "Get",
                url: '@Url.Action("GetLoanByUserId", "UserRoles",new { userId = userManager.GetUserId(User)})',
                success: function (data) {
                    let data1 = [];
                    data.forEach(e => {
                        if (e.status.statusName.toLowerCase() !== 'отменена' && e.status.statusName.toLowerCase() !== 'возвращено')
                            data1.push(e);
                    })
                    dataTable = data1;
                    $('#tablel').DataTable({
                        data: data1,
                        columns: [
                            { data: 'date' },
                            { data:'book.bookPicture'},
                            { data: 'book.name' },
                            { data: 'status.statusName' },
                            { data: 'id' }

                        ],
                        columnDefs: [{
                            targets: 0,
                            render: function (data, type, row, meta) {
                                var date = new Date(data);
                                var dd = date.getDate();
                                if (dd < 10) dd = '0' + dd;

                                var mm = date.getMonth() + 1;
                                if (mm < 10) mm = '0' + mm;

                                var yy = date.getFullYear();
                                if (yy < 10) yy = '0' + yy;

                                return dd + '.' + mm + '.' + yy + ' ' + date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds();
                            }
                        },
                            {
                                targets: 1,
                                orderable: false,
                                render: function (data, type, row, meta) {
                                    return `<img src="${data}"/>`;
                                }
                            },
                        {
                            targets:4 ,
                            orderable: false,
                            render: function (data, type, row, meta) {
                                if (row.status.statusName.toLowerCase() !== 'в пользовании') {

                                    return `<button type="button" class="btn btn-danger" onClick="deleteLoan(${data})">Отменить</button >
                                    <button class="btn btn-primary" onClick="CallPrint(${row['id']})">Скачать PDF</button>`;
                                }
                                return '';
                            }
                        }],
                        order: [[0, 'desc']]
                    })
                }
            });
    }

    function deleteLoan(data) {
        $.ajax({
            type: "Get",
            url: '@Url.Action("DeleteLoan", "UserRoles")',
            data: {
                loanId: data,
            },
            success: function (data) {
                document.location.reload();
            }
        });
    }

    function CallPrint(strid) {
        let item = dataTable.filter(d => d['id'] == strid)[0]
        console.log(item);

        let htmlDoc = $(`
            <table>
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Date</th>
                        <th>Picture</th>
                        <th>Title</th>
                        <th>FullName</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>${item.id}</td>
                        <td>${formatDate(item.date)}</td>
                        <td><img src="${item.book.bookPicture}" style="width:100px; heigth:100px; object-fit:cover;"/></td>
                        <td>${item.book.name}</td>
                        <td>${item.user.firstName} ${item.user.lastName}</td>
                        <td>${item.status.statusName}</td>
                </tbody>
            </table>

        `)
        var opt = {
            margin: 1,
            filename: `Заявка_${item.id}`,
            jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
        };
        html2pdf()
        .set(opt)
        .from(htmlDoc[0].outerHTML)
        .save();

    }

    function formatDate(date) {
        var date = new Date(date);
        var dd = date.getDate();
        if (dd < 10) dd = '0' + dd;

        var mm = date.getMonth() + 1;
        if (mm < 10) mm = '0' + mm;

        var yy = date.getFullYear();
        if (yy < 10) yy = '0' + yy;

        return dd + '.' + mm + '.' + yy + ' ' + date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds();
    }

</script>